NAME=sarif world
FILE=-
ARGS=-i ../sarif.r2.js
CMDS=<<EOF
?e hello sarif
?ee error message
EOF
EXPECT=<<EOF
hello sarif
EOF
EXPECT_ERR=<<EOF
error message
EOF
RUN

NAME=sarif help
FILE=-
ARGS=-i ../sarif.r2.js
CMDS=<<EOF
sarif help
EOF
EXPECT=<<EOF
Usage: sarif [action] [args...]
sarif add [L] [id] [M]  - add a new result with selected driver
sarif alias [newalias]  - create an alias for the sarif command
sarif export            - export added rules as sarif json
sarif help              - show this help message (-h)
sarif list [help]       - list drivers, rules and results
sarif load [file]       - import sarif info from given file
sarif r2                - generate r2 script to import current doc results
sarif reset             - unload all documents
sarif select [N]        - select the nth driver
sarif unload [N]        - unload the nth document
sarif version           - show plugin version
EOF
RUN

NAME=sarif load document
ARGS=-i ../sarif.r2.js
CMDS=<<EOF
sarif load bins/files/sarif.rules.mastg.json
sarif list docs
EOF
EXPECT=<<EOF
0 bins/files/sarif.rules.mastg.json
 + mastg 1.0.0
EOF
EXPECT_ERR=<<EOF
Document loaded. Use 'sarif list'
EOF
RUN

NAME=sarif drivers
ARGS=-i ../sarif.r2.js
CMDS=<<EOF
sarif list drivers
sarif load bins/files/sarif.driver.ns.json
?e ---
?e drivers
sarif list drivers
?e ---
?e docs
sarif list docs
?e ---
?e rules
sarif list rules
EOF
EXPECT=<<EOF
---
drivers
  0   SARIF Findings      0.0.1
---
docs
0 bins/files/sarif.driver.ns.json
 + SARIF Findings 0.0.1
---
rules
SF00001             Context Registered Broadcast Receivers Not Protected with Permissions
SF00002             Manifest Declared Broadcast Receivers Not Protected With Permissions Can Leak Data to Other Apps
SF00003             Implicitly Exported Components Block Installation to Android 12
EOF
EXPECT_ERR=<<EOF
Document loaded. Use 'sarif list'
EOF
RUN

NAME=sarif version
FILE=-
ARGS=-i ../sarif.r2.js
CMDS=<<EOF
sarif version
EOF
EXPECT=<<EOF
0.0.1
EOF
RUN

NAME=sarif add result
ARGS=-i ../sarif.r2.js
# BROKEN=1
CMDS=<<EOF
sarif load bins/files/sarif.driver.ns.json
sarif select 0
sarif list rules
?e --- sarif add warning
sarif add warning SF00001 this is not ok
?e --- sarif r2
sarif r2
?e --- sarif dump
sarif dump
EOF
EXPECT=<<EOF
  0   SARIF Findings      0.0.1
Selected driver:
* 0   SARIF Findings      0.0.1
SF00001             Context Registered Broadcast Receivers Not Protected with Permissions
SF00002             Manifest Declared Broadcast Receivers Not Protected With Permissions Can Leak Data to Other Apps
SF00003             Implicitly Exported Components Block Installation to Android 12
--- sarif add warning
SF00001             Context Registered Broadcast Receivers Not Protected with Permissions
SF00002             Manifest Declared Broadcast Receivers Not Protected With Permissions Can Leak Data to Other Apps
SF00003             Implicitly Exported Components Block Installation to Android 12
--- sarif r2
# SARIF script for radare2
# this is not ok @ 0x7b / 128 SF00001
CC SF00001:this is not ok @ 0x7b
f sarif.0 128 0x7b
--- sarif dump
{
  "$schema": "http://json.schemastore.org/sarif-2.1.0",
  "version": "2.1.0",
  "runs": [
    {
      "tool": {
        "driver": {
          "name": "SARIF Findings",
          "semanticVersion": "0.0.1",
          "rules": [
            {
              "id": "SF00001",
              "deprecatedIds": [
                "unprotected_context_registered_broadcast_receivers"
              ],
              "name": "Context Registered Broadcast Receivers Not Protected with Permissions",
              "defaultConfiguration": {
                "level": "error"
              },
              "properties": {
                "security-severity": "4",
                "security-severity-vector": "CVSS:3.0/AV:L/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N",
                "tags": [
                  "security"
                ]
              }
            }
          ]
        }
      },
      "results": [
        {
          "ruleId": "SF00001",
          "message": {
            "text": "this is not ok"
          },
          "level": "warning",
          "locations": [
            {
              "physicalLocation": {
                "artifactLocation": {
                  "uri": "binary://example-binary",
                  "uriBaseId": "%SRCROOT%"
                },
                "region": {
                  "byteOffset": 1024,
                  "byteLength": 128
                }
              },
              "properties": {
                "memoryAddress": "123"
              }
            }
          ]
        }
      ]
    }
  ]
}
EOF
EXPECT_ERR=<<EOF
Document loaded. Use 'sarif list'
EOF
RUN
